name: Flutter CI/CD

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed .
      
      - name: Analyze code
        run: flutter analyze --fatal-infos

  test:
    name: Run Tests
    needs: analyze
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run tests with coverage
        run: flutter test --coverage
      
      - name: Check coverage threshold
        run: bash scripts/check_coverage.sh
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
      
      - name: Upload coverage artifact
        uses: actions/upload-artifact@v5
        with:
          name: coverage-report
          path: coverage/

  build-dev:
    name: Build Dev APK
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK (Dev)
        run: |
          flutter build apk \
            --dart-define=BUILD_ENV=dev \
            --dart-define=API_URL=https://api-dev.example.com \
            --release
      
      - name: Upload Dev APK
        uses: actions/upload-artifact@v5
        with:
          name: app-dev-release
          path: build/app/outputs/flutter-apk/app-release.apk

  build-staging:
    name: Build Staging APK
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Build APK (Staging)
        run: |
          flutter build apk \
            --dart-define=BUILD_ENV=staging \
            --dart-define=API_URL=https://api-staging.example.com \
            --release
      
      - name: Upload Staging APK
        uses: actions/upload-artifact@v5
        with:
          name: app-staging-release
          path: build/app/outputs/flutter-apk/app-release.apk

  build-prod:
    name: Build Production APK
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Increment version
        id: version
        run: |
          bash scripts/increment_version.sh
      
      - name: Build APK (Production)
        run: |
          flutter build apk \
            --dart-define=BUILD_ENV=prod \
            --dart-define=API_URL=https://api.example.com \
            --release
      
      - name: Upload Production APK
        uses: actions/upload-artifact@v5
        with:
          name: app-prod-release
          path: build/app/outputs/flutter-apk/app-release.apk
      
      - name: Create Release Tag
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add pubspec.yaml
          git commit -m "chore: bump version to ${{ steps.version.outputs.NEW_VERSION }}"
          git tag -a "v${{ steps.version.outputs.NEW_VERSION }}" -m "Release v${{ steps.version.outputs.NEW_VERSION }}"
          git push
          git push --tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
